define(["jquery","app/fabric/fabric-shape"],function(a,b){return{shape:b,myCanvas:null,canvasWidth:a("#defaultTableWidth").val(),canvasHeight:a("#defaultTableHeight").val(),loadDataTable:a("#loadDataTable").val(),saveDataTable:a("#saveDataTable").val(),getUniqueID:a("#getUniqueID").val(),deleteDataID:a("#deleteDataID").val(),clearDataTable:a("#clearDataTable").val(),init:function(){console.log("Init Fabric.."),App.fabricJs.initCanvas(),App.fabricJs.initObject(),App.initFunc(App),App.fabricJs.shape.init()},initCanvas:function(){console.log("Init Fabric Canvas..");var b=a("<canvas/>",{id:"canvas_table"});a("#canvasWrapper").html(b),App.fabricJs.myCanvas=new fabric.Canvas("canvas_table"),App.fabricJs.myCanvas.setHeight(App.fabricJs.canvasHeight),App.fabricJs.myCanvas.setWidth(App.fabricJs.canvasWidth),App.fabricJs.myCanvas.backgroundColor="#FFF",App.fabricJs.myCanvas.selectionColor="rgba(0,255,0,0.3)",App.fabricJs.myCanvas.selectionBorderColor="red",App.fabricJs.myCanvas.selectionLineWidth=5,App.fabricJs.myCanvas.selectionDashArray=[3,2],App.fabricJs.myCanvas.renderAll(),App.fabricJs.myCanvas.clear(),App.fabricJs.myCanvas.on("object:modified",function(a){var b=a.target,c=b.getBoundingRect();(c.left<0||c.top<0||c.left+c.width>App.fabricJs.myCanvas.getWidth()||c.top+c.height>App.fabricJs.myCanvas.getHeight())&&(b.getAngle()!=b.originalState.angle?b.setAngle(b.originalState.angle):(b.setTop(b.originalState.top),b.setLeft(b.originalState.left),b.setScaleX(b.originalState.scaleX),b.setScaleY(b.originalState.scaleY)),b.setCoords())}).on("object:selected",function(b){a("#delete_table").prop("disabled",!1)}).on("selection:cleared",function(){a("#delete_table").prop("disabled",!0)}),a("#delete_table").prop("disabled",!0),App.fabricJs.disabledBtn(!0)},initObject:function(){a("#table_floor_canvas").on("change",function(b){if(App.overlayUI.show(),App.fabricJs.initCanvas(),a(this).val()>0){App.fabricJs.disabledBtn(!1);var c=a.ajax({type:"POST",url:App.fabricJs.loadDataTable,data:{floor_id:a(this).val()}});c.done(function(a){var b=JSON.parse(a);b.status===!0&&(App.fabricJs.myCanvas.clear(),App.fabricJs.myCanvas.loadFromJSON(b.items),App.fabricJs.myCanvas.renderAll(),App.fabricJs.myCanvas.calcOffset(),App.fabricJs.myCanvas.forEachObject(function(a){a.toObject=function(a){return function(){return fabric.util.object.extend(a.call(this),{id:this.id})}}(a.toObject)})),App.overlayUI.hide()}),c.fail(function(a,b){App.overlayUI.hide()}),c.always(function(){})}else App.fabricJs.disabledBtn(!0),App.overlayUI.hide()});var b=a("#addRect"),c=a("#addTriangle"),d=a("#addCircle"),e=a("#delete_table"),f=a("#clear_table"),g=a("#save_table");b.on("click",function(b){var c=a("#table_floor_canvas").val(),d=a("#table_name").val();if(""==d)return App.alert("Table name cannot empty!"),!1;if(d.length>25)return App.alert("Max 25 Characters!"),!1;if(c>0){var e=(App.fabricJs.getRandomLeftTop(),App.fabricJs.shape.createRect(d)),f=a.ajax({type:"POST",url:App.fabricJs.getUniqueID});f.done(function(a){var b=JSON.parse(a);e.id=b.random_id,App.fabricJs.myCanvas.add(e),App.fabricJs.myCanvas.setActiveObject(e)}),f.fail(function(a,b){App.overlayUI.hide()}),f.always(function(){}),a("#table_name").val("")}else App.alert("please, choose floor first")}),c.on("click",function(b){var c=a("#table_floor_canvas").val(),d=a("#table_name").val();if(""==d)return App.alert("Table name cannot empty!"),!1;if(d.length>25)return App.App.alert("Max 25 Characters!"),!1;if(c>0){var e=(App.fabricJs.getRandomLeftTop(),App.fabricJs.shape.createTriangle(d)),f=a.ajax({type:"POST",url:App.fabricJs.getUniqueID});f.done(function(a){var b=JSON.parse(a);e.id=b.random_id,App.fabricJs.myCanvas.add(e),App.fabricJs.myCanvas.setActiveObject(e)}),f.fail(function(a,b){App.overlayUI.hide()}),f.always(function(){}),a("#table_name").val("")}else App.alert("please,choose floor first")}),d.on("click",function(b){var c=a("#table_floor_canvas").val(),d=a("#table_name").val();if(""==d)return App.alert("Table name cannot empty!"),!1;if(d.length>25)return App.alert("Max 25 Characters!"),!1;if(c>0){var e=(App.fabricJs.getRandomLeftTop(),App.fabricJs.shape.createCircle(d)),f=a.ajax({type:"POST",url:App.fabricJs.getUniqueID});f.done(function(a){var b=JSON.parse(a);e.id=b.random_id,App.fabricJs.myCanvas.add(e),App.fabricJs.myCanvas.setActiveObject(e)}),f.fail(function(a,b){App.overlayUI.hide()}),f.always(function(){}),a("#table_name").val("")}else App.alert("choose floor first")}),e.on("click",function(a){function b(){var a=App.fabricJs.myCanvas.getActiveObject(),b=App.fabricJs.myCanvas.getActiveGroup();if(b){var c=b.getObjects();App.fabricJs.myCanvas.discardActiveGroup(),c.forEach(function(a){App.fabricJs.deleteObjOnServer(a.id,a)})}else{if(!a)return!1;App.fabricJs.deleteObjOnServer(a.id,a)}}App.confirm("Apakah anda yakin akan hapus meja ini?",b)}),f.on("click",function(a){App.confirm("Apakah anda yakin akan hapus semua meja di lantai ini?",function(){App.fabricJs.deleteAllObjOnServer()})}),g.on("click",function(a){App.fabricJs.sendObjToserver()})},capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},pad:function(a,b){for(;a.length<b;)a="0"+a;return a},getRandomNum:function(a){return Math.floor(Math.random()*a+1)},getRandomLeftTop:function(){var a=50;return{left:fabric.util.getRandomInt(0+a,700-a),top:fabric.util.getRandomInt(0+a,500-a)}},disabledBtn:function(b){a("#save_table").prop("disabled",b),a("#clear_table").prop("disabled",b),a("#addRect").prop("disabled",b),a("#addTriangle").prop("disabled",b),a("#addCircle").prop("disabled",b)},sendObjToserver:function(){App.overlayUI.show();var b=JSON.stringify(App.fabricJs.myCanvas),c=a.ajax({type:"POST",url:App.fabricJs.saveDataTable,data:{floor_id:a("#table_floor_canvas").val(),data:b}});c.done(function(a){App.overlayUI.hide()}),c.fail(function(a,b){App.overlayUI.hide()}),c.always(function(){})},deleteObjOnServer:function(b,c){var d=a.ajax({type:"POST",url:App.fabricJs.deleteDataID,data:{id:b}});d.done(function(a){""!=a&&1==a?App.fabricJs.myCanvas.remove(c):App.alert("Gagal menghapus semua tabel. satu atau lebih tabel tidak kosong")}),d.fail(function(a,b){}),d.always(function(){})},deleteAllObjOnServer:function(b){var c=a.ajax({type:"POST",url:App.fabricJs.clearDataTable,data:{id:a("#table_floor_canvas").val()}});c.done(function(a){""!=a&&1==a?App.fabricJs.myCanvas.clear():App.alert("Gagal menghapus semua tabel. Satu atau lebih tabel tidak kosong! Pastikan tidak ada yang dine in pada tabel yag ingin dihapus!")}),c.fail(function(a,b){}),c.always(function(){})}}});